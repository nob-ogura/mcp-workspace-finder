# 社内情報横断検索システム PoC 要件定義

## 1. 目的
- 社内に散在する Google Drive / Slack / GitHub の情報を、MCP を用いた **LLMによるクエリ生成と要約 + ホストプログラムによる並列検索オーケストレーションを組み合わせた検索** で横断し、情報の所在と概要を即時に把握できる体験を概念実証する。
- データの事前蓄積やベクトル検索を行わず、リアルタイム API 呼び出しで成立することを示す。

## 2. スコープ
- **PoC 対象データソース:** Google Drive, Slack, GitHub（各1系統のみ、社内テナント/組織を想定）。3サービスとも **実トークン / 実アカウント** を用いる（モック・サンプルデータは自動テストのみとする）。
- **実行モードの基本方針:** 通常起動は実鍵をデフォルトとし、`--mock` または `ALLOW_REAL=0` 指定時のみモックを起動する。実鍵が欠如している場合は警告を出し、自動でモックへフォールバックしたうえで処理を継続する。
- **出力チャネル:** ターミナル上の CLI (Typer+Rich) 。
- **検索対象:** ユーザー本人がアクセス可能な範囲に限定。Slack は User Token (xoxp-) を前提に Public/Private/DM を含む。
- **除外:** ベクトル検索・RAG・事前インデックス構築、Notion 等追加ツール、Bot 追加開発、レポート自動生成、大量バッチ収集。

## 3. 想定利用者とユースケース
- 利用者: 社内メンバー（技術者を中心、PoC 参加者のローカル環境）。
- 主要ユースケース:
  - Q1: 「Project Alpha の設計ドキュメントはどこ？」→ リンクと概要を即返却。
  - Q2: 「最近のSlackで◯◯の議論」→ スレッド要約とリンク。
  - Q3: 「repo X の関連 Issue」→ Issue/PR の抜粋と URL。

## 4. 機能要件 (FR)
**UI**
- FR-UI-01: Typer ベースの REPL で自然文質問を受け付ける。
- FR-UI-02: Rich で回答本文を Markdown 描画し、進行状況を逐次表示（例: Searching Slack..., Reading files...）。
- FR-UI-03: 回答直下に「根拠リンク」セクションを設け、サービス別に最大3件、合計最大9件の URL/パスを番号付きで表示。
- FR-UI-04: LLM が生成した各サービス向け検索クエリを併記し、0件時は代替クエリ候補を提示。

**検索・取得**
- FR-SR-01: ツール未指定の質問はホストアプリが LLM を用いて Slack / Drive / GitHub 向けの検索クエリを生成した上で、各 MCP **検索 Tool**（search）を asyncio 等で非同期・並列実行し、サービスごと上位3件（タイトル/スニペット/URI）・全体9件以内の「候補一覧」を取得する。
- FR-SR-02: 各候補に含まれる URI/パスを用い、上位ヒット（各サービス最大3件）に対して **そのサービスが本文取得に対応する方法（`read_resource` もしくは `get_issue` / `get_message` 等の Tool）** を並列実行し、取得した本文をそのまま LLM に渡す。検索 Tool 単体で全文が返らない前提とし、本文取得手段がないデータソースではスニペットのみで回答する。特に Slack メッセージや GitHub Issue/PR は検索結果に含まれる permalink を `read_resource` に渡しても取得できない場合が多いため、専用 Tool を使う前提とする。
- FR-SR-03: ホスト側は「どのサービスのどの種別（ファイル/Issue/PR/Message 等）がどの取得手段に対応するか」をマッピングしておき、検索結果の URI が `read_resource` 非対応の場合は適切な Tool を選択して再取得する。例: Google Drive は `read_resource` でファイル本文取得、GitHub はファイルは `read_resource` / Issue・PR は `get_issue` 等、Slack はスレッド本文を `get_message` / `get_thread` で取得。
- FR-SR-04: 0件時は即時結果を返し、日付範囲拡大やキーワード緩和などの代替クエリ案を提示。自動リトライは行わない。

**クエリ生成・拡張**
- FR-QG-01: LLM は検索実行ではなく、ユーザー質問から各サービスの検索パラメータ（クエリ）を抽出・生成し、各サービスの検索構文に正規化する（例: Slack search.messages, GitHub `repo:org/repo path:docs ...`）。3サービス分（Slack/GitHub/Drive）のクエリを一括で出力させる。
- FR-QG-01 補足: 検索構文の知識は各 MCP サーバーがリソーステンプレートとして提供し、ホストがそれを System 参照として OpenAI API の function calling / JSON mode に渡して 3 サービス分のクエリを一括生成する。実装詳細（スキーマやプロンプト構成）は設計段階で詰める。
- FR-QG-02: 意味検索を行わない代替として、LLM が類義語・関連語による OR 検索を自動生成しヒット率を底上げする。
- FR-QG-03: 検索構文知識はプロンプトまたは MCP サーバーのリソーステンプレートから取得し、ホストが注入する。

**サブプロセス管理 / 接続**
- FR-PROC-01: ホストアプリは Slack/GitHub/Drive の MCP サーバーをローカルサブプロセスとして起動・管理する。
- FR-PROC-02: 接続は Stdio パイプで行い、HTTP/SSE ラッパーサーバーは用いない。
- FR-PROC-03: Python 製サーバーはホスト venv 上で `python -m` またはエントリポイント実行、Slack サーバーは Go 製バイナリを直接起動する。
- FR-PROC-04: 認証済みクレデンシャルファイルを同一ディレクトリで共有し、再起動時に再利用する。

**認証・権限制御**
- FR-AUTH-01: 初回起動時のみホストが対話的に OAuth を案内し、認証ファイルをローカルに保存する（ブラウザ自動オープン可）。
- FR-AUTH-02: Slack は User Token (xoxp-) を環境変数で事前設定する前提とし、PoC では本人権限をそのまま利用する。
- FR-AUTH-03: GitHub は個人の PAT（classic または fine-grained）でリポジトリ読取が可能な最小スコープを付与し、PoC でも実トークンを使用する。
- FR-AUTH-04: Google Drive は実ユーザーの OAuth トークン (`token.json`) を用い、PoC でも実データへのアクセスで検証する。
- FR-AUTH-05: トークンファイルは Git へコミット禁止・ローカル保存のみとし、パスは設定ファイルで指定可能とする。

**回答のトレーサビリティ**
- FR-TR-01: 回答には根拠となるリソースの URL / パスを必ず含め、LLM 生成に依存しない実データをホスト側で結合する。
- FR-TR-02: ソース取得に失敗した場合も回答本文を返しつつ、根拠欄に警告を表示する。

**エラー・例外**
- FR-ER-01: Slack/GitHub/Drive いずれかが失敗しても他サービス結果を返すフェイルソフト動作とする。
- FR-ER-02: API レートリミット (429) 検知時は該当サービスの取得をスキップし、ユーザーへ警告を表示する。自動リトライは行わない。

## 5. 非機能要件 (NFR)
- NFR-RL-01: CLI は単一プロセス常駐し、REPL 連続利用に耐える。サーバープロセス死活を検知し再起動を試行する。
- NFR-SEC-01: 認証情報はローカル端末に限定保存し、環境変数/`.env`/専用ディレクトリに保管。キーの漏洩防止をドキュメント化する。
- NFR-UX-01: 進行状況・検索クエリ・根拠リンクを可視化し、ブラックボックス感を抑える。
- NFR-EXT-01: MCP サーバー追加時は設定ファイル（例: `servers.yaml`）への追記のみで動作拡張できる。
- NFR-OPS-01: コンテナ不使用。ローカル venv と単体バイナリのみでセットアップ完了できる手順を提供する。

## 6. システム構成要件
- Host: Python 3.10+, Typer, Rich, `mcp` SDK, asyncio ベース。単一プロセスで REPL と MCP 通信を管理し、クエリ生成依頼→検索 Tool 並列実行→上位ヒットに対する本文取得（`read_resource` または各サービス固有 Tool）を並列実行→要約依頼までを段階的にオーケストレーションする。
- LLM: OpenAI `gpt-4o mini`。Tool Calling 性能に加え、複数サービス分のクエリを一括で生成できる構造化データ生成能力を要件とする。
- MCP Servers:
  - Google Drive: Python リファレンス実装 (`modelcontextprotocol/servers` 内 `gdrive`)、Stdio 接続。
  - GitHub: `github/github-mcp-server`（Python、Stdio）。
  - Slack: `korotovsky/slack-mcp-server`（Go バイナリ、Stdio）。起動時 `SLACK_USER_TOKEN` 必須。
- 通信方式: すべて Stdio。ポート開放不要。

## 7. データ・権限ポリシー
- 個人の権限をそのまま使用し、越権アクセスは行わない。
- DM/Private を LLM へ送信する際の自動マスキングは未実装であることを明示し、PoC では運用で注意する。
- トークン/認証ファイルはローカル保存のみ、持ち出し禁止、Git への混入禁止。

## 8. 制約・前提
- PoC 期間中のみの運用を想定し、監査ログ・最小権限設計は本番移行時に再設計する。
- ベクトル検索・Rerank を行わず、全文検索 + クエリ拡張のみで成立させる。
- API レートリミットを考慮し、サービスごと `max_results=3`、合計最大9件で取得を打ち切る。
- ローカル環境で動作し、コンテナやクラウドデプロイを行わない。
- LLM の自律ループ（ReAct 等）には依存せず、並列性や重試行はホスト側のロジックで制御する。
- MCP の仕様上、検索（Tool）と閲覧（Resource/別 Tool）は分離されるため、検索結果の種類（ファイル/Issue/PR/Message 等）に応じて `read_resource` **または** 各サービス固有の取得 Tool を用いる。`read_resource` は主にファイル系 URI（例: Drive のファイル、GitHub リポジトリ内の blob）向けであり、Slack メッセージや GitHub Issue/PR 等の動的オブジェクトは `read_resource` 非対応を前提にし、対応する取得 Tool を選択する。

## 9. 受入基準 (DoD)
- AC-01: 上記3サービスに対し、単一質問から 3件×3サービス以内の結果と要約を返し、根拠リンクを表示できること。
- AC-02: 0件時に代替クエリ候補が提示されること。
- AC-03: 認証ファイル生成後、再起動しても再認証なしで検索できること。
- AC-04: Slack の Private/DM を含む検索結果が返る（User Token 前提）。
- AC-05: 進行状況メッセージと検索クエリが可視化されること。

## 10. リスクと対応
- R1: 個人トークン漏洩リスク → ローカル保存ルールと Git への混入禁止を手順化。
- R2: レートリミット → 並列上限と `max_results=3` を固定し、429 時は警告のみで継続。
- R3: ノイズ混入（Rerank 無し） → 上位ヒットのまま返す方針を明示し、PoC 評価で許容範囲を検証。
- R4: DM/Private 情報の機微 → デフォルトで本文ログは残さず、`--debug` opt-in 時のみ簡易マスキング（メール/ドメイン/トークン/ユーザーID等）を施して JSONL に記録する運用とする。本番ではより厳格なマスキング/権限制御を再設計。

## 11. 成果物
- 要件を満たす CLI 実装（ソースコード・設定ファイルひな型・セットアップ手順）。
- 本ドキュメント (docs/Requirements.md)。

## 12. テストと CI 方針
- 単体・ユニットレベルのテストは常にモック/ダミーデータのみを使用し、ネットワークや実トークンが無くても `pytest -m mock` で緑になることを基準とする（CI 既定ジョブ）。
- E2E はモード切替式とし、`pytest -m mock` をデフォルトとする。`pytest -m real` は `ALLOW_REAL=1` かつ `--mock` 無しの場合にのみ実行し、鍵が欠如していれば警告してスキップする。CI は常にモックのみを実行する。
- CI トリガーは GitHub Actions の PR / push を想定し、既定ではモックのみを実行する。実鍵 E2E は `workflow_dispatch` もしくはスケジュール（例: 夜間/週次）で明示的に走らせ、成果は Slack 等で通知する運用を前提とする。
- 実環境 E2E で用いるデータセット（Slack ワークスペース、GitHub リポジトリ、Drive フォルダ）は検証用に固定し、各サービス 3 件以内のスモークにとどめてレートリミットと機微情報漏洩リスクを抑える。ログは PoC のため本文を平文で残してよく、トークンなど明白なシークレットのみマスクする。
