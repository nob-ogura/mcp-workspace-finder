# 実装計画

## 全フェーズ共通: テスト・CI 方針
- 単体テスト・ユニットレベルは常にモック/ダミーデータで実行し、ネットワークや実鍵が無くても `pytest -m mock` が緑になる状態を CI 既定とする。
- E2E はマーカー/フラグで切り替え可能にする（例: `pytest -m mock` と `pytest -m real`）。デフォルトはモックで、`ALLOW_REAL=1` かつ `--mock` 無しのときのみ実鍵・実環境を用いる。実行には OpenAI / Slack xoxp- / GitHub PAT / Drive token の存在チェックを行い、欠如時は警告してスキップ。
- CI のトリガー（例: GitHub Actions の PR/push）はモックのみを走らせる。実鍵 E2E は `workflow_dispatch` やスケジュール（例: 夜間 1 回）で明示的に起動し、結果を Slack 通知等で共有する。
- 実鍵 E2E では安定検証用のワークスペース/リポジトリ/Drive フォルダを固定し、件数上限（各サービス 3 件以内）と短時間スモークにとどめる。ログはトークン・メール・ドメインをマスクし、成果物に残さない。

## フェーズ1: 環境とプロジェクト基盤
- Python 3.10+（最新パッチ）を前提に、依存管理は **poetry ロック** で統一する。`poetry.lock` をソース管理し再現性を担保。
- CLI エントリポイント骨格を用意し、REPL 起動までの最小ルートを確保。
- `servers.yaml` のテンプレートと `.env.example` を配置し、必要キーを明示。
- `docs/Requirements.md` に沿った依存とランタイム前提を README に追記。
- Git 管理外にすべきファイルを `.gitignore` に追加。
- DoD: `python -m app` が鍵未設定でも必ず REPL を起動しヘルプ表示できる（起動時に実鍵不足を警告し、自動でモックにフォールバックする）／`poetry install` が成功する／`.env.example` と `servers.yaml` テンプレートが存在し必須項目が列挙されている。

## フェーズ2: MCP サーバ起動・監視レイヤ
- `servers.yaml` を読み取り、各サーバーの起動コマンド・環境変数・ポート/stdio 設定を抽象化（`mode: mock|real` のみを持つ想定でテンプレートも統一する）。
- 非同期で 3 サーバーを起動し、起動失敗・異常終了を検知してリスタート or スキップを決定するロジックを実装。
- サーバーごとに health/ready の簡易チェック (初回メッセージ受信、タイムアウト判定) を追加。
- 起動対象サービスは **Slack / GitHub / Google Drive**。通信はすべて Stdio。Slack は Go バイナリ、GitHub/Drive は Python モジュール起動を前提とする。
- Mock/real 優先度を一本化: `--mock` 指定時は最優先で強制モック、未指定で `ALLOW_REAL=1` のときのみ実鍵を許可し、それ以外は常にモック。`servers.yaml` の `mode` と CLI/環境指定が食い違う場合は CLI を優先し、起動ログに「CLI override」警告を出す（CI は常にモック起動を強制）。
- 実鍵が存在しない場合は起動時に警告し、自動でモックにフォールバックする（プロセスは継続、検索のみモック扱い）。
- リスタートは一時的なポート占有やプロセスクラッシュのみ最大 1 回試行し、認証エラーなど恒久失敗は即スキップして残りを継続する。
- DoD: REPL 起動時に 3 サーバーの子プロセスが立ち上がり、1 サービスをあえて失敗させても残りが動作し警告が出る／異常終了時にリスタートが 1 回試行されログに残る／`ALLOW_REAL=1` かつ `--mock` 無しの場合にのみ実サーバーが起動し、それ以外（`--mock` 指定や実鍵欠如時）はモックにフォールバックする導線が存在する／設定と CLI が矛盾した場合に CLI 優先でモードが決まり起動ログに「CLI override」警告が出る。

## フェーズ3: 簡易実鍵・実環境スモーク
- `ALLOW_REAL=1` かつ `--mock` 未指定のときだけ **3 サービスすべてを実トークン/実アカウント** で起動し、最小スモークを手動で行う（CI は常にスキップ、鍵欠如時は警告してモックに落ちるためこのスモークはスキップ扱い）。それ以外はモックで起動し本フェーズのスモークをスキップ扱いとする。
- 目的: サーバー起動→認証ファイル読み込み/取得→各サービスの検索 API が 1 回成功することを確認する（レスポンス成功コードまで）。本文取得・要約は後続フェーズで任意確認にとどめる。
- テスト用の一時データが必要な場合は作成し、実行直後に削除する手順を README か `docs/Requirements.md` に追記。
- ログ・例外に鍵や個人情報が残らないよう、トークン・メール・ドメインを伏字化する最低限のマスキング/ログ抑制をこの段階で実装する（完全でない旨は後続ドキュメントで注意喚起）。
- 対象サービスとトークン種別:
  - **Slack:** `xoxp-` User Token で `search.messages`。本人参加の全チャンネル＋DM を検索（Bot 招待不要）。スコープ想定: `search:read`, `channels:history`, `groups:history`, `im:history`, `users:read`。
  - **GitHub:** 個人の **PAT (classic もしくは fine-grained)** を前提とし、検索 API に必要な最小スコープ (repo 読取) を付与。対象は検証用の org/repo を 1 つ以上指定。
  - **Google Drive:** OAuth を通した **実ユーザーの認可トークン**（`token.json`）を使用し、ファイル検索が成功することを確認。検証用フォルダを 1 つ決めてアクセス権を本人に付与。
- ワークスペース/リポジトリ/Drive フォルダは PoC 用検証環境をそれぞれ 1 つ以上指定し、再現可能な状態を共有。
- DoD: 3 サービスそれぞれで「実トークンを用いたサーバー起動＋検索 API 成功（手動）」を確認し、Slack では DM/Private を 1 件以上含む検索を通す／失敗事象を issue 化して共有（CI では実行しない）。本文取得・要約の完走はこのフェーズの必須条件に含めない（要約までの自動化はフェーズ10で扱う）。

## フェーズ4: 入力制御とコマンド体系（自動モード選択）
- Typer ベースの単一エントリポイント。TTY で引数 `--query` 未指定なら REPL に自動遷移し、非対話入力（`--query` 指定または stdin パイプ）ならワンショット実行後に即終了。
- Rich による進行表示の土台 (ステータス/スピナー) を配置。
- REPL 時のみ内部コマンドを有効化：`quit` / `reload` / `help` に加え、`debug on/off`、`logpath` 表示などデバッグ補助を実装する。
- モード決定はフェーズ2の優先度（`--mock` > `ALLOW_REAL=1` > それ以外はモック）に従い、`servers.yaml` の `mode` が食い違う場合は CLI を優先して起動ログに「CLI override」警告を出す。
- DoD: `python -m app` を引数なしで起動するとプロンプトが表示され自然文を処理できる／`python -m app --query "..."` あるいは `echo "..." | python -m app` で一回実行して終了する／モード判定がユーザーの事前選択を不要にしている／設定と CLI が食い違う際に CLI 優先でモードが決まり警告ログが出る。

## フェーズ5: LLM プロンプト設計・検索パラメータ生成
- サービス別検索構文ガイドと JSON Schema (Slack/GitHub/Drive) をシステムプロンプトに組み込み、function calling で一括生成。
- 0 件時の代替クエリ生成を含めた出力契約を定義。
- OpenAI API ラッパーを実装し、エラーハンドリング (timeout/retry) を付与。
- モデル設定（決定済）: `gpt-4o-mini`, 温度 0.2〜0.3, タイムアウト 15s, リトライ 1 回。0 件時は代替クエリを提示する。
- DoD: 与えた質問に対し、Slack/GitHub/Drive 用検索パラメータ JSON を返し、代替クエリも併せて生成されるユニットテストが通る／出力が Schema にバリデートされる。

## フェーズ6: 検索・本文取得パイプライン (並列)
- サービス別に「検索 Tool → 本文取得 Tool」マッピングを実装し、`max_results=3` を遵守。
- `asyncio.gather` で検索と本文取得を並列実行し、結果を共通データモデルに整形。
- サービス単位のフェイルソフト (失敗時に他サービス継続) を組み込む。
- レートリミット/一時エラー処理の唯一の定義を本フェーズに置く: タイムアウト 10s、429 は即スキップして警告、ネットワーク/一時エラーは指数バックオフ（例: 0.5s→1s）付きで 1 回リトライし、失敗時はスキップ。実装は共通関数（例: `retry_policy.py`）に集約する前提。
- 実行時モードはフェーズ2の優先度で決定し、`servers.yaml` と CLI/環境指定が矛盾した場合は CLI を優先して「CLI override」警告をログに残す。
- DoD: ダミー/モック MCP サーバーで検索 3 件以内 + 取得が行われ、1 サービス失敗時も残り結果が返る統合テストが通る／並列実行でタイムアウト上限内に完了する／429 とその他エラーでポリシーが分岐する挙動をテストで確認する／ポリシー変更時に `retry_policy.py` など 1 か所を更新すれば全テストが通ることを確認する／設定と CLI が食い違う際に CLI 優先でモードが決まり警告ログが残る。

## フェーズ7: 要約・レンダリング
- 取得結果を LLM に渡し、Markdown 形式の要約と根拠リンク番号を生成するプロンプトを実装。
- Rich でサービス別セクション、根拠リンク、代替クエリ (0 件時) を描画。
- 要約モデルは `gpt-4o-mini`、温度 0.3。表示形式はサービス別見出し + 数字付きリストで根拠リンクを示す。
- DoD: 3 サービス混在の入力から Markdown 要約と番号付きリンクが REPL に表示される／0 件時に即時終了し代替クエリのみが表示される動作が手動・自動テストで確認できる。

## フェーズ8: レートリミット・例外処理とロギング
- フェーズ6で定義したレートリミット/一時エラー処理ポリシーをそのまま利用する（重複定義しない）。
- デフォルトでは本文・クエリを永続ログに残さない。`--debug` オプションで明示 opt-in した場合のみ JSON Lines 形式の詳細ログ (入力、生成クエリ、検索結果、取得 URI、例外) を出力する。
- `--debug` 時はメール/ドメイン/トークン/ユーザーIDなど明白なシークレットを簡易マスキングして `./logs/app.log` に追記（ローテーションなし）。
- DoD: 429 シミュレーション時にサービスがスキップされ警告が出る／一時エラーが 1 回リトライ後にスキップされる挙動をテストで確認する（ポリシーはフェーズ6の共通関数経由で適用される前提）／`--debug` 実行時のみログファイルに JSONL が追記され、平常時は本文ログが残らない状態で REPL が落ちない。

## フェーズ9: セキュリティ・設定ドキュメント
- `.env` や認証ファイルのパスを設定ファイルで明示し、ログはデフォルト非記録であることと、`--debug` 時の簡易マスキングが完全ではない旨を CLI ヘルプ/README に記載。
- `.gitignore` でトークン/認証ファイルを除外し、初回セットアップ手順を README に追記。
- 秘密情報は `secrets/<service>.env` に配置し、そのパスを `.env` で指し示すハイブリッド運用とする。`secrets/` は `.gitignore` で除外する。
- DoD: `.gitignore` に秘密情報が追加されている／README に Slack DM/Private が検索対象であることと簡易マスキングの限界、初期セットアップ手順が記載されている。

## フェーズ10: 実鍵・実環境テスト
- 専用の検証用ワークスペース（Slack/GitHub/Drive など）を用意し、実トークンを用いた検索→取得→要約までのシナリオを定義。
- テストデータの作成・クリーンアップ手順、キーのスコープ/ローテーション方針を `docs/Requirements.md` か README に明記。
- 実トークンを用いた検索→取得→要約シナリオは `ALLOW_REAL=1` かつ `--mock` 無しの場合のみ実行する。それ以外（CI／`--mock` 指定／`ALLOW_REAL` 未設定や 0）の場合はモックに切り替わる。
- 実鍵テストは `ALLOW_REAL=1` かつ `--mock` 無しの場合のみ有効化し、それ以外（鍵欠如含む）は警告してスキップする。`servers.yaml` の `mode` と CLI/環境指定が矛盾した場合でも CLI 優先でモードを決定し「CLI override」警告を残す。キーのローテーションは四半期ごとに実施。
- DoD: 実環境に対して検索→取得→要約のシナリオが通り、テストデータが後処理で削除される／実鍵テストが CI ではスキップされる仕組みと明示的 opt-in がある／設定と CLI が食い違う場合に CLI 優先でモードが決まり警告ログが残る／フェーズ3の最小スモークとの差分（フェーズ3=検索成功まで、フェーズ10=要約までの自動シナリオ）がドキュメントで説明されている。

## フェーズ11: E2E スモークとデモ
- モックサーバー or 錯綜レスポンダを用意し、典型シナリオ (ヒットあり/なし、片サービス落ち) のスモークテストを自動化。
- 簡易デモスクリプトまたは録画手順を用意し、PoC の期待挙動を再現できるようにする。
- デモシナリオは「ヒットあり／ヒットなし／片サービス落ち」に加え、実鍵モードを含める。収録は asciinema と再生用スクリプトを採用（動画ファイルは持たない）。
- DoD: `pytest -m smoke` 等でエンドツーエンドのモックテストが通る／デモ手順書に従い CLI 上で期待出力を再現できる。
