# フェーズ6: 検索・本文取得パイプライン (並列) — タスク一覧

## タスク1: サービス別「検索→本文取得」マッピングと共通データモデル
- Drive/GitHub/Slack それぞれの検索 Tool 出力を、対応する本文取得 Tool・パラメータにマッピングするルックアップを実装し、共通の検索結果モデル・本文取得モデルに整形する。`max_results=3` をサービス単位で強制する。

### 受入基準 (Gherkin)
```
シナリオ: 検索結果が対応する本文取得パラメータに変換される
  前提: Slack/GitHub/Drive 向けの検索結果モックが用意されている
  もし: 各検索結果をマッピング関数に渡す
  ならば: サービスごとに適切な取得 Tool 名とパラメータが付与された共通モデルが返る
```
```
シナリオ: max_results が 3 を超えない
  前提: 1 サービスあたり 5 件の検索結果をモックする
  もし: マッピング後の結果リスト件数を確認する
  ならば: 先頭 3 件のみが保持され、4 件目以降は含まれない
```

## タスク2: 非同期並列パイプラインの実装 (検索 + 本文取得)
- `asyncio.gather` を用いて、検索と本文取得をサービス横断で並列実行するフローを構築する。検索完了後に取得ステップへ進み、両ステップとも `max_results=3` を守る。

### 受入基準 (Gherkin)
```
シナリオ: 検索と本文取得が並列で実行される
  前提: 3 サービスの検索/取得が 0.2 秒遅延するモックである
  もし: パイプラインを実行する
  ならば: 総処理時間が 0.4 秒未満となり、並列実行されていることが確認できる
```
```
シナリオ: 取得不可の場合でも他サービスが継続する
  前提: GitHub 取得モックが例外を投げ、Slack/Drive は成功する
  もし: パイプラインを実行する
  ならば: Slack/Drive の結果は返り、GitHub は警告付きでスキップされる
```

## タスク3: レートリミット・一時エラー向けリトライ/スキップポリシー共通化
- タイムアウト 10s、429 は即スキップ、ネットワーク/一時エラーは指数バックオフ (0.5s→1s) で 1 回リトライし、それでも失敗時はスキップするポリシーを共通ヘルパー（例: `retry_policy.py`）に実装し、検索・取得両方で使用する。

### 受入基準 (Gherkin)
```
シナリオ: 429 応答時に即スキップされる
  前提: 検索モックが 429 エラーを返す
  もし: パイプラインを実行する
  ならば: 当該サービスは即スキップされ、他サービスは継続し、429 がログに警告として記録される
```
```
シナリオ: 一時エラーが 1 回リトライされる
  前提: 本文取得モックが 1 回目に接続エラー、2 回目に成功を返す
  もし: パイプラインを実行する
  ならば: リトライ後に成功として結果が含まれ、リトライ回数が記録される
```

## タスク4: モード優先順位と CLI override ログの統合
- フェーズ2で定義したモード優先度（`--mock` > `ALLOW_REAL=1` > それ以外はモック）を検索・取得パイプラインに適用し、`servers.yaml` と CLI/環境指定が矛盾した場合は CLI 優先とし「CLI override」警告を残す。

### 受入基準 (Gherkin)
```
シナリオ: CLI が servers.yaml のモードを上書きする
  前提: servers.yaml で Drive が real、CLI で --mock を指定している
  もし: パイプライン初期化を行う
  ならば: Drive はモックモードで起動し、ログに "CLI override" を含む警告が出力される
```
```
シナリオ: ALLOW_REAL=1 かつ --mock 未指定で real が選択される
  前提: 環境変数 ALLOW_REAL=1 が設定され、servers.yaml で GitHub が real 指定
  もし: パイプライン初期化を行う
  ならば: GitHub は real モードで選択され、override 警告は出力されない
```

## タスク5: モック MCP サーバーによる統合テスト
- フェーズ6のパイプラインをモック MCP サーバー（またはフェイクレスポンダ）で E2E 実行し、並列性・フェイルソフト・レートリミット処理が期待通り動くことを確認する Pytest を追加する。

### 受入基準 (Gherkin)
```
シナリオ: 正常系で 3 サービス分の本文が返る
  前提: 3 サービスの検索と取得が成功するモックを用意する
  もし: パイプラインを実行する
  ならば: 3 サービス分の本文付き結果が返り、件数は各サービス 3 件以内である
```
```
シナリオ: 1 サービス失敗時も残りが返る
  前提: Slack 取得モックが恒久エラー、GitHub/Drive は成功する
  もし: パイプラインを実行する
  ならば: GitHub/Drive の結果が返り、Slack はスキップ理由がログに残る
```
```
シナリオ: タイムアウト上限内で完了する
  前提: すべての検索/取得モックが 0.5 秒で応答する
  もし: パイプラインを実行する
  ならば: 全処理が 2 秒未満で完了し、並列化が効いていることが確認できる
```
