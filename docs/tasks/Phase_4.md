# フェーズ4: 入力制御とコマンド体系 — タスク一覧

## タスク1: 入力ソースに応じた自動モード判定
- TTY/非 TTY、`--query` 指定、stdin パイプ有無を判定し、REPL かワンショット実行を自動で選択する分岐を実装する。判定結果を起動ログに明示し、不要なプロンプトを出さない。

### 受入基準 (Gherkin)
```
シナリオ: TTY かつ --query 無しで REPL に遷移する
  前提: 端末が TTY である
  かつ: CLI を `python -m app` で --query を付けずに起動する
  ならば: REPL プロンプトが表示される
  かつ: プロンプト表示後もプロセスが継続し、ワンショット出力のみで終了しない
```
```
シナリオ: --query 指定時にワンショットで終了する
  前提: 端末が TTY である
  もし: `python -m app --query "社内ナレッジを検索"` を実行する
  ならば: REPL プロンプトは表示されない
  かつ: 質問処理が完了すると exit code 0 で即時終了する
```
```
シナリオ: stdin パイプ入力でワンショットになる
  前提: `echo "Slack のDMを検索" | python -m app` のように標準入力がパイプ接続されている
  ならば: REPL プロンプトは表示されない
  かつ: 入力テキストが検索に用いられ、処理完了後にプロセスが終了する
```

## タスク2: ワンショット実行パスの処理完了と終了制御
- 非対話モード（`--query` または stdin）で質問を受け取り、進行表示付きで 1 回の検索フローを完了させたら即時終了するルートを実装する。終了コードと出力を統一する。

### 受入基準 (Gherkin)
```
シナリオ: --query でワンショット処理が完了する
  前提: 必要なモックサーバーが起動可能な状態である
  もし: `python -m app --query "GitHub の最新PRを教えて"` を実行する
  ならば: 進行表示が「Preparing query...」から始まり検索・要約のステップが表示される
  かつ: 1 度だけ結果が描画され exit code 0 で終了する
```
```
シナリオ: パイプ入力でも同じフローで終了する
  前提: `echo "Google Driveの設計資料"` が標準入力から渡される
  もし: `echo "Google Driveの設計資料" | python -m app` を実行する
  ならば: 進行表示が一連のステータスを出した後、結果表示して exit code 0 で終了する
  かつ: REPL プロンプトは一切表示されない
```

## タスク3: REPL 内部コマンドの実装（quit/reload/help/debug/logpath）
- REPL 専用コマンド `quit`/`reload`/`help`/`debug on|off`/`logpath` を受け付け、即時反応するハンドラを実装する。`help` でコマンド一覧を表示し、`debug` トグルはログレベルを切り替える。

### 受入基準 (Gherkin)
```
シナリオ: help で内部コマンド一覧が表示される
  前提: REPL プロンプトが表示されている
  もし: ユーザーが `help` と入力する
  ならば: quit/reload/help/debug/logpath 各コマンドの説明が 1 回表示される
```
```
シナリオ: debug on/off がログ出力を切り替える
  前提: REPL プロンプトでデフォルトは debug off である
  もし: `debug on` を入力する
  ならば: デバッグログが有効になった旨のメッセージが表示される
  かつ: 続けて `debug off` を入力すると無効化メッセージが表示される
```
```
シナリオ: quit と reload が即時に作用する
  前提: REPL プロンプトが表示されている
  もし: `reload` を入力する
  ならば: サーバー接続の再読み込みが開始され完了メッセージが表示される
  もし: 続けて `quit` を入力する
  ならば: プロセスが終了しシェルに戻る
```
```
シナリオ: logpath が現在のログ保存先を返す
  前提: REPL プロンプトが表示されている
  もし: `logpath` を入力する
  ならば: ログファイルの絶対パスが 1 行で表示される
```

## タスク4: 進行表示（土台）の配置
- Rich のステータス/スピナーを用い、準備・検索・要約など主要ステップの進行状況を表示するコンポーネントを組み込む。REPL/ワンショット双方で共有し、重複表示や多重スピナーを避ける。

### 受入基準 (Gherkin)
```
シナリオ: 主要ステップのステータスが順番に表示される
  前提: モックサーバーが起動し検索が成功する状態である
  もし: `python -m app --query "Slack の設計ドキュメント"` を実行する
  ならば: 画面に「Preparing query...」「Searching ...」「Summarizing...」の順でステータスが表示される
  かつ: ステータスが完了するとスピナーが停止し結果表示に切り替わる
```
```
シナリオ: REPL でも同じコンポーネントが再利用される
  前提: REPL プロンプトが表示されている
  もし: ユーザーが検索クエリを入力する
  ならば: 同じステータス表示が 1 回だけ現れ、完了後に再びプロンプトが表示される
```

## タスク5: モード決定優先度と「CLI override」警告の表示
- 実行モードの優先度を `--mock` > `ALLOW_REAL=1` > それ以外は mock に固定し、`servers.yaml` の設定と矛盾した場合に CLI 優先で「CLI override」警告を 1 回出力する。選択結果を起動時に明示する。

### 受入基準 (Gherkin)
```
シナリオ: --mock 指定が servers.yaml を上書きする
  前提: servers.yaml で GitHub の mode が real になっている
  もし: `python -m app --mock` を起動する
  ならば: 起動ログに「CLI override」警告が 1 回表示される
  かつ: GitHub の起動モードが mock として記録される
```
```
シナリオ: ALLOW_REAL=1 のときのみ real が選択される
  前提: servers.yaml で Slack の mode が real になっている
  かつ: 環境変数 ALLOW_REAL=1 が設定されている
  もし: `python -m app` を起動する
  ならば: Slack の起動モードが real としてログに表示される
  かつ: --mock を付けた場合は mock が優先される
```
```
シナリオ: どの条件にも当てはまらない場合は mock になる
  前提: ALLOW_REAL が未設定で --mock も指定していない
  もし: `python -m app` を起動する
  ならば: 3 サービスすべての起動モードが mock として表示される
  かつ: 実鍵チェックが行われなくても起動が継続する
```

