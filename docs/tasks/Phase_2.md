# フェーズ2: MCP サーバ起動・監視レイヤ — タスク一覧

## タスク1: モード決定ロジックと servers.yaml ローダーの実装
- `servers.yaml` を読み込み、Slack/GitHub/Drive 向けの起動定義（コマンド・環境変数・mode）を内部表現にマッピングする。CLI/環境優先度を `--mock` > `ALLOW_REAL=1` > その他は mock とし、設定ファイルと矛盾した場合は CLI 優先で「CLI override」警告をログに残す。
- 実鍵不足時は起動前に検知し、警告を 1 回出した上でモックモードへ自動フォールバックさせる。

### 受入基準 (Gherkin)
```
シナリオ: CLI 指定が servers.yaml を上書きする
  前提: servers.yaml に Slack の mode が real と設定されている
  かつ: 環境変数 ALLOW_REAL が 1 に設定されている
  もし: `python -m app --mock` を実行する
  ならば: 起動ログに「CLI override」警告が 1 回表示される
  かつ: Slack の起動モードが mock として記録される
```
```
シナリオ: ALLOW_REAL=1 のときのみ real が有効
  前提: servers.yaml に GitHub の mode が real と設定されている
  かつ: `ALLOW_REAL=1` が設定されている
  もし: `python -m app` を実行する（--mock なし）
  ならば: GitHub の起動モードが real として選択される
  かつ: 選択結果が起動ログに出力される
```
```
シナリオ: 鍵不足時に自動モックへフォールバックする
  前提: `.env` に Slack の必須トークンが未設定である
  かつ: `ALLOW_REAL=1` が設定されている
  もし: `python -m app` を実行する
  ならば: 「鍵不足によりモックへフォールバック」旨の警告が 1 回表示される
  かつ: Slack の起動モードが mock として選択される
  かつ: プロセスは異常終了しない
```

## タスク2: サーバープロセス起動コマンドの抽象化と環境準備
- Slack (Go バイナリ) と GitHub/Drive (Python モジュール) の起動コマンドを mode ごとにテンプレート化し、servers.yaml の値と環境変数を埋め込んで stdio 接続用サブプロセスを生成するユーティリティを実装する。
- 必須パスや実行権限の事前チェックを行い、不足時はサービス単位でわかりやすいエラーを返す。

### 受入基準 (Gherkin)
```
シナリオ: real モードで定義されたコマンドが組み立てられる
  前提: servers.yaml に Slack real 用の exec パスと環境変数が設定されている
  もし: モード解決結果が real となった場合にサーバー起動を呼び出す
  ならば: Slack の子プロセスが servers.yaml に記載されたコマンドで起動する
  かつ: 標準入出力がパイプ接続で確立される
```
```
シナリオ: 必須パス不足をサービス単位で検知する
  前提: Drive サーバーの exec パスが存在しない
  もし: サーバー起動ユーティリティを呼び出す
  ならば: Drive の起動がスキップされ「実行パス不備」旨のエラーがログに出る
  かつ: Slack/GitHub の起動処理は継続する
```
```
シナリオ: mock モードでモックコマンドが選択される
  前提: GitHub サーバーに mock 用コマンドが servers.yaml に定義されている
  もし: モード解決結果が mock となった場合にサーバー起動を呼び出す
  ならば: GitHub の子プロセスが mock コマンドで起動する
```

## タスク3: 非同期起動と初期ヘルスチェックの実装
- 3 サービスを `asyncio` で並列起動し、初回メッセージ受信または起動タイムアウトによる readiness 判定を追加する。タイムアウト・起動失敗はサービス単位で警告し、他サービスの起動を継続する。

### 受入基準 (Gherkin)
```
シナリオ: 3 サービスが並列で起動し readiness を返す
  前提: servers.yaml に Slack/GitHub/Drive の mock 定義が揃っている
  もし: `python -m app` を REPL で起動する
  ならば: 3 サービスの子プロセスが並列に立ち上がる
  かつ: 各サービスが初回メッセージを返すかタイムアウト内に ready 判定される
```
```
シナリオ: 1 サービスが起動失敗しても残りが継続する
  前提: Slack サーバーのコマンドが意図的に失敗する設定になっている
  もし: `python -m app` を起動する
  ならば: Slack の起動失敗が警告として表示される
  かつ: GitHub と Drive が ready となり REPL が利用可能な状態で維持される
```
```
シナリオ: readiness タイムアウトを検知する
  前提: GitHub サーバーが標準出力を返さないモックに差し替えられている
  もし: サーバー起動を実行する
  ならば: 既定タイムアウト経過後に「readiness timeout」警告が表示される
  かつ: プロセス監視が残りサービスで継続する
```

## タスク4: 異常終了監視とリスタートポリシー (最大1回)
- サービスごとにプロセス終了を監視し、クラッシュや一時的なポート占有と判断できる場合のみ最大 1 回まで再起動する。認証エラーや設定不備など恒久失敗は即スキップし、理由をログに残す。

### 受入基準 (Gherkin)
```
シナリオ: 異常終了時に 1 回だけ再起動する
  前提: Slack サーバープロセスを強制終了できるテストフックが有効になっている
  もし: 起動後に Slack プロセスを kill する
  ならば: ログに「restart attempt #1」旨が出力される
  かつ: Slack サーバーが 1 回だけ再起動される
```
```
シナリオ: 2 回目以降は再起動しない
  前提: 直前のシナリオで再起動済みである
  もし: 再度 Slack プロセスを kill する
  ならば: 「再起動上限に達した」旨の警告が表示される
  かつ: 追加の再起動は行われない
```
```
シナリオ: 認証エラーは即スキップする
  前提: Drive サーバーが認証エラーを標準エラーに出力して終了するモックに置き換えられている
  もし: サーバー起動を実行する
  ならば: 「auth error」もしくは同等のキーワードを検知して再起動を試行しない
  かつ: 他サービスの監視は継続する
```

## タスク5: 起動ログと監視ステータスの可視化
- 起動モード、ready/failed、リスタート有無をサービス別に集約し、Rich などで REPL 画面に表示できるログ/メッセージを整備する。警告は 1 度だけ出し、以降はステータス欄で把握できるようにする。

### 受入基準 (Gherkin)
```
シナリオ: 起動時にサービス別ステータスが表示される
  前提: 3 サービスが正常に起動する設定になっている
  もし: `python -m app` を起動する
  ならば: REPL 画面に Slack/GitHub/Drive の起動モードと ready 状態が表示される
  かつ: 警告は表示されない
```
```
シナリオ: 警告は 1 回だけ出力されステータスで維持される
  前提: GitHub サーバーが最初の起動で失敗し再起動で成功するモックに差し替えられている
  もし: `python -m app` を起動する
  ならば: 起動直後に GitHub の警告が 1 回表示される
  かつ: 再起動後はステータス表示が ready に更新され以降同じ警告が繰り返し出ない
```

