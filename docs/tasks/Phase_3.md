# フェーズ3: 簡易実鍵・実環境スモーク — タスク一覧

## タスク1: 実鍵スモークの起動条件とスキップ判定
- `ALLOW_REAL=1` かつ `--mock` 未指定のときだけ 3 サービスを実鍵モードで起動し、スモーク対象として扱う。条件を満たさない場合は自動でモック起動とし「スモーク未実施（mock）」を明示的にログへ出力する。

### 受入基準 (Gherkin)
```
シナリオ: 実鍵条件を満たしたときにスモークが有効化される
  前提: 環境変数 ALLOW_REAL が 1 に設定されている
  かつ: CLI で --mock オプションを指定していない
  もし: CLI を起動する
  ならば: Slack/GitHub/Drive が real モードとして選択される
  かつ: ログに「real smoke enabled」のようなスモーク開始メッセージが 1 回表示される
```
```
シナリオ: 実鍵条件を満たさない場合にスモークがスキップされる
  前提: ALLOW_REAL が未設定または 0 に設定されている もしくは CLI に --mock を指定する
  もし: CLI を起動する
  ならば: 3 サービスが mock モードで起動する
  かつ: ログに「real smoke skipped (mock mode)」等のスキップ理由が 1 回表示される
  かつ: 実環境へのネットワーク呼び出しが行われない
```

## タスク2: サービス別の実鍵起動と認証ファイルチェック
- Slack/GitHub/Drive の実鍵起動前に必要なトークン/認証ファイルの存在と読取権限を検査し、欠如時はサービス単位で警告してモックへフォールバックする。全サービスが real で揃わない場合はスモーク全体を「未実施」として扱う。

### 受入基準 (Gherkin)
```
シナリオ: 必須トークンが揃っているときに 3 サービスが実鍵で起動する
  前提: Slack xoxp-, GitHub PAT, Drive token.json が所定パスに存在し読み取り可能である
  かつ: ALLOW_REAL=1 で --mock を指定していない
  もし: CLI を起動する
  ならば: 3 サービスすべてが real モードで起動し ready になる
  かつ: 起動ログに各サービスの実鍵利用が明示される
```
```
シナリオ: 認証ファイル不足時にサービス単位でモックへフォールバックする
  前提: Drive の token.json が存在しない
  もし: CLI を起動する
  ならば: Drive に対して「認証ファイル不足」警告が 1 回表示される
  かつ: Drive は mock モードで起動し、Slack/GitHub は起動処理を継続する
  かつ: スモーク全体のステータスが「未実施（欠損あり）」として記録される
```

## タスク3: 実環境検索スモークの実行と結果記録
- 実鍵モード時に 3 サービスそれぞれで検索 Tool を 1 回実行するスモーク手順（例: `scripts/smoke_real.sh` もしくは CLI オプション）を用意し、成功/失敗を統一フォーマットでログまたはレポートファイルに残す。Slack では DM/Private を含む検索ヒットを最低 1 件確認する。

### 受入基準 (Gherkin)
```
シナリオ: 3 サービスで検索 API が 1 回ずつ成功する
  前提: ALLOW_REAL=1 かつ --mock 未指定で CLI が起動している
  かつ: 3 サービスの認証ファイルが有効である
  もし: スモーク用コマンド (例: `scripts/smoke_real.sh`) を実行する
  ならば: Slack/GitHub/Drive それぞれで検索 Tool が成功レスポンスを返す
  かつ: Slack の検索結果に DM もしくは Private チャンネルのヒットが 1 件以上含まれる
  かつ: ログに「real smoke passed」とサービス別の成功フラグが記録される
```
```
シナリオ: スモーク失敗時に記録と共有が行われる
  前提: スモーク用コマンドが実行されている
  もし: いずれかのサービスで検索が失敗する
  ならば: ログに失敗理由とサービス名が記録される
  かつ: 失敗事象を issue または報告ファイルに起票するフローが実行される
```

## タスク4: ログマスキングの最低限実装
- スモーク実行時のログに含まれるトークン、メールアドレス、ドメイン名などを簡易マスクし、平文で残さない。デバッグログ有効時も同じマスクルールを適用する。

### 受入基準 (Gherkin)
```
シナリオ: トークンやメールがログに平文で残らない
  前提: デバッグログ出力を有効にしてスモーク用コマンドを実行する
  かつ: 実トークンとメールアドレスが入力に含まれる
  ならば: 出力ログ中のトークンは先頭数文字以外が伏字になる
  かつ: メール/ドメインは一部がマスクされた形で記録され平文が含まれない
```

## タスク5: 検証用ワークスペースとクリーンアップ手順の整備
- Slack/GitHub/Drive それぞれの検証用ワークスペース/リポジトリ/フォルダを 1 つ以上指定し、作成・後片付けの手順を README または `docs/Requirements.md` に追記する。スモークで一時作成したデータは実行直後に削除する手順を明文化する。

### 受入基準 (Gherkin)
```
シナリオ: 検証環境と後処理がドキュメント化されている
  前提: README もしくは docs/Requirements.md を参照する
  もし: フェーズ3の検証環境準備セクションを読む
  ならば: Slack の対象ワークスペース、GitHub リポジトリ、Drive フォルダの具体名がわかる
  かつ: スモーク後に作成したテストメッセージやファイルを削除する手順が記載されている
  かつ: 手順に従えば追加の権限や設定がなくても後始末が完了する
```
