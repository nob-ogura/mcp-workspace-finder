# フェーズ5: LLM プロンプト設計・検索パラメータ生成 — タスク一覧

## タスク1: サービス別検索パラメータ JSON Schema の定義とバリデーション
- Slack/GitHub/Drive 向け検索パラメータの JSON Schema をリポジトリに追加し、Python から検証できるユーティリティ関数を実装する。`max_results=3` の上限や必須フィールドをスキーマで強制し、LLM からの応答を受け取る入口でバリデーションをかける。

### 受入基準 (Gherkin)
```
シナリオ: 有効な Slack 検索パラメータが検証を通過する
  前提: Slack 検索スキーマが `schemas/slack_search.json` に定義されている
  もし: `{"service":"slack","query":"design OR 設計","max_results":3}` を検証する
  ならば: バリデーションが成功し例外が発生しない
```
```
シナリオ: max_results 超過で検証が失敗する
  前提: GitHub 検索スキーマが `schemas/github_search.json` に定義されている
  もし: `max_results` が 4 のペイロードを検証する
  ならば: バリデーションエラーが発生し、理由に `max_results` の制約が含まれる
```
```
シナリオ: 必須フィールド欠如で Drive 検索が弾かれる
  前提: Drive 検索スキーマが `schemas/gdrive_search.json` に定義されている
  もし: `query` を欠いたオブジェクトを検証する
  ならば: バリデーションエラーが発生する
```

## タスク2: 検索パラメータ生成プロンプトと function calling 設定
- システムプロンプトにサービス別構文ガイドとスキーマ概要を埋め込み、`gpt-4o-mini` を JSON/function calling モードで呼び出して 3 サービス分の検索パラメータを一括生成する関数を実装する。温度 0.2〜0.3、タイムアウト 15s、リトライ 1 回を固定し、LLM 呼び出し引数がこれに従うことを保証する。

### 受入基準 (Gherkin)
```
シナリオ: 3 サービス分の検索パラメータが一括で生成される
  前提: プロンプトが Slack/GitHub/Drive の構文ガイドを含んでいる
  もし: 「設計レビューの議事録を探して」という質問を入力する
  ならば: LLM から Slack/GitHub/Drive の各検索パラメータ JSON が 1 回の呼び出しで返る
  かつ: すべてのペイロードがタスク1のスキーマ検証を通過する
```
```
シナリオ: OpenAI 呼び出しパラメータが固定設定で送出される
  前提: LLM クライアントがモックされている
  もし: 検索パラメータ生成関数を呼び出す
  ならば: モデル名が `gpt-4o-mini`、temperature が 0.2〜0.3、タイムアウトが 15 秒、リトライが 1 回であることが記録に残る
```
```
シナリオ: スキーマ違反応答はリトライ後にエラーを返す
  前提: モック LLM が最初に不正 JSON、次に同じ不正 JSON を返す
  もし: 検索パラメータ生成関数を呼ぶ
  ならば: 2 回目のリトライ後に例外を送出し、呼び出し元が捕捉できる
```

## タスク3: 代替クエリ生成とゼロ件ハンドリング
- LLM から検索パラメータと同時に代替クエリ候補を返す設計にし、検索結果が 0 件の場合は代替クエリのみを表示するフローを実装する。代替クエリは最低 2 件生成し、元の質問とサービス横断のカバレッジを保持する。

### 受入基準 (Gherkin)
```
シナリオ: 代替クエリが 2 件以上生成される
  前提: 代替クエリ出力がスキーマで `alternatives` 配列として定義されている
  もし: 任意の質問を入力して LLM を呼び出す
  ならば: 代替クエリが少なくとも 2 件含まれ、空文字列は含まれない
```
```
シナリオ: 検索結果 0 件時に代替クエリのみを表示する
  前提: 検索実行ステップが 0 件を返すモックに差し替えられている
  もし: ワンショット実行を行う
  ならば: 要約や本文表示はスキップされ、代替クエリのリストだけが出力される
```
```
シナリオ: 代替クエリは元質問の意図を保持する
  前提: 「非公開リポジトリの設計資料」という質問を入力する
  もし: LLM からの代替クエリを検査する
  ならば: 少なくとも 1 件に "設計" もしくは "デザイン" が含まれる
```

## タスク4: LLM レイヤのユニットテストとマスキング確認
- 検索パラメータ生成・代替クエリ生成の関数群に対し、モック LLM を用いたユニットテストを追加する。プロンプト・入力ログに API キーやトークンが混入しないことを確認し、ログマスキング（既存の logging_utils）と併用して安全性を担保する。

### 受入基準 (Gherkin)
```
シナリオ: モック LLM でユニットテストが通過する
  前提: LLM 呼び出しがモックで差し替えられている
  もし: pytest を実行する
  ならば: フェーズ5で追加したテストがすべて成功する
```
```
シナリオ: ログにシークレットが含まれない
  前提: OpenAI API Key が環境変数 `OPENAI_API_KEY` に設定されている
  かつ: デバッグログが有効化されている
  もし: 検索パラメータ生成関数を実行してログを確認する
  ならば: 出力ログに `OPENAI_API_KEY` の値そのものが含まれない
```
```
シナリオ: スキーマ検証エラーがテストで捕捉できる
  前提: モック LLM が不正な JSON を返す
  もし: pytest で該当ケースを実行する
  ならば: テストが期待通り例外を検知し、失敗せずに完了する
```
